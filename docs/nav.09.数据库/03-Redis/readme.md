# Redis

## 有哪些优缺点

### 优点

- 读写性能优异， Redis 能读的速度是 110000 次/s，写的速度是 81000 次/s
- 支持数据持久化，支持 AOF 和 RDB 两种持久化方式
- 支持事务，Redis 的所有操作都是原子性的，同时 Redis 还支持对几个操作合并后的原子性执行
- 数据结构丰富，除了支持 string 类型的 value 外还支持 hash、set、zset、list 等数据结构
- 支持主从复制，主机会自动将数据同步到从机，可以进行读写分离

### 缺点

- 数据库容量受到物理内存的限制，不能用作海量数据的高性能读写，因此 Redis 适合的场景主要局限在较小数据量的高性能操作和运算上
- Redis 不具备自动容错和恢复功能，主机从机的宕机都会导致前端部分读写请求失败，需要等待机器重启或者手动切换前端的 IP 才能恢复
- 主机宕机，宕机前有部分数据未能及时同步到从机，切换 IP 后还会引入数据不一致的问题，降低了系统的可用性
- Redis 较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂。为避免这一问题，运维人员在系统上线时必须确保有足够的空间，这对资源造成了很大的浪费

## 为什么要用

主要从“高性能”和“高并发”这两点来看待这个问题。

**高性能：**

假如用户第一次访问数据库中的某些数据。这个过程会比较慢，因为是从硬盘上读取的。将该用户访问的数据存在数缓存中，这样下一次再访问这些数据的时候就可以直接从缓存中获取了。操作缓存就是直接操作内存，所以速度相当快。如果数据库中的对应数据改变的之后，同步改变缓存中相应的数据即可！

**高并发：**

直接操作缓存能够承受的请求是远远大于直接访问数据库的，所以我们可以考虑把数据库中的部分数据转移到缓存中去，这样用户的一部分请求会直接到缓存这里而不用经过数据库。

## 为什么快

- 完全基于内存，绝大部分请求是纯粹的内存操作，非常快速。数据存在内存中，类似于 HashMap，HashMap 的优势就是查找和操作的时间复杂度都是 O(1)；
- 数据结构简单，对数据操作也简单，Redis 中的数据结构是专门进行设计的；
- 采用单线程，避免了不必要的上下文切换和竞争条件，也不存在多进程或者多线程导致的切换而消耗 CPU，不用去考虑各种锁的问题，不存在加锁释放锁操作，没有因为可能出现死锁而导致的性能消耗；
- 使用多路 I/O 复用模型，非阻塞 IO；
- 使用底层模型不同，它们之间底层实现方式以及与客户端之间通信的应用协议不一样，Redis 直接自己构建了 VM 机制 ，因为一般的系统调用系统函数的话，会浪费一定的时间去移动和请求；

## 有哪些数据类型

String，List，Set，Zset(sorted set)，Hash

## 应用场景

- 计数器。重读写场景
- 缓存
  - 热点
  - 会话
- 查找表
- 分布式锁（SETNX）
- zset 适合做排行榜

## 持久化机制

- RDB（默认，Redis DataBase）。按照一定的时间将内存的数据以快照的形式保存到硬盘中，对应产生的数据文件为 dump.rdb。通过配置文件中的 save 参数来定义快照的周期
  - 优点
    - 只有一个文件 dump.rdb，方便持久化
    - 性能最大化，fork 子进程来完成写操作，让主进程继续处理命令，所以是 IO 最大化。使用单独子进程来进行持久化，主进程不会进行任何 IO 操作，保证了 redis 的高性能
    - 数据集较大时，启动效率较高
  - 缺点
    - 安全性低。持久化间隔期间故障，则会产生数据丢失
- AOF （Append on file）
  - 优点
    - 数据安全
    - 数据一致性好
    - 支持 rewrite
  - 缺点
    - 体积较大，恢复速度慢
    - 数据集大，启动效率低

## 如何扩容

- 作为缓存，则使用一致性哈希进行动态扩容缩容
- 持久化存储，需要使用过定的 keys-to-nodes 映射关系，需要使用 redis 集群才能做到

## 过期删除策略

- 定是国企
- 惰性过期
- 定期过期

## 内存淘汰策略

全局

- noeviction: 写入报错
- allkeys-lru: 删除最少使用 keys
- allkeys-random: 随即移除

过期

- volatile-lru: 在过期时间的键空间中移出 lru
- volatile-random: 当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，随即移除
- volatile-ttl: 过期时间更早的 key 优先移除

## 如何做内存优化

- 使用好自带的数据结构

## redis 线程模型

- 基于 Reactor 模式开发了网络事件处理器，称为 文件事件处理器（单线程）
  - 多个套接字
  - IO 多路复用程序
  - 文件事件分派器
  - 事件处理器

## 事务

Redis 事务的本质是通过 MULTI、EXEC、WATCH 等一组命令的集合

- 是一个单独的隔离操作
- 是原子操作

### 三个阶段

- 事务开始 MULTI
- 命令入队
- 事务执行 EXEC
  - 如有除事务之外的请求，放到队列中

事务管理 ACID

- 原子性
- 一致性
- 隔离性
- 持久性

- Redis 为单进程，所以能够保证事务隔离
- 事务不保证原子性，且不支持回滚
  
## 集群方案

- 哨兵模式
- 官方 Redis Cluster 方案
- 客户端分配
- 代理服务器分片
- Redis 主从
